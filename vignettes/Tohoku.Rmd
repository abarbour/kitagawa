---
title: "Strain and Pore-pressure Observations from the 2011 M9 Tohoku Earthquake"
author: "Andrew J Barbour"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: REFS.bib
---

Here I show how the modeling tools in kitagawa can be
used to study actual data.  Specifcally, I will show
records of strain and pore-pressure from borehole
stations in the Plate Boundary Observatory.

For more information see @barbour2011 and @barbour2015.

```{r, echo=TRUE}
library(kitagawa)
```

We first load the psd package, which includes the dataset:
and the spectral estimation tools. We're interested in
the spectral relationship between pore pressure $p$ and
_areal_ strain $E_A$ -- the change in borehole
diameter, which can be related to volume strain, during the seismic
portion of the record.

```{r, echo=TRUE}
library(psd)
data(Tohoku)
toh.dat <- with(subset(Tohoku, epoch=='seismic'),{
    cbind(scale(1e-6*areal, scale=FALSE), # scale to strain, remove mean
          scale(1e2*pressure.pore, scale=FALSE) # to Pa, remove mean
          )
  })
colnames(toh.dat) <- c('input','output')
```

Note how the records look like mirrow images of each other:
```{r, echo=FALSE, fig.show='hold', fig.width=7., fig.height=4.5}
par(mar=c(3,3,0.2,0.2))
plot(ts(toh.dat), yax.flip = TRUE)
```
This is consistent with the theory of linear poroelasticity,
which says
$$
p \approx - \frac{4}{3} B \mu E_A
$$
for an undrained Poisson's ratio of $1/3$, where
$B$ is Skempton's ratio, and $\mu$ is the elastic
shear modulus. In this case the _apparent_ proportionality is 
`r round(coef(lm(output ~ input-1, as.data.frame(toh.dat)))/1e9, 3)` $GPa / \epsilon$, 
but we will see how this value is actually frequency dependent.

First let's use Don Percival's package `sapa`
to estimate a multitaper cross spectrum
```{r, echo=TRUE, fig.show='hold', fig.width=7., fig.height=5.5}
library(sapa)
k <- 15
print(toh.cs <- sapa::SDF((toh.dat), method='multitaper', n.taper=k, sampling.interval=1))
plot(toh.cs, xscale='log')
```
with the following Hanning tapers:
```{r, echo=FALSE, fig.show='hold', fig.width=7., fig.height=2.5}
par(mar=c(3,2,1,0.2))
matplot(t(unclass(attr(toh.cs,'taper'))), type='l', lty=1, xlab='', ylab='time, seconds')
```

### Coherence, Admittance, and Phase

If the results of the `SDF` computation give
a matrix of complex spectra $[S_{11}, S_{12}, S_{22}]$, 
the _coherence_ spectrum $\gamma^2$ can be calculated by
$$
\gamma^2 = \frac{\left|S_{12}\right|^2}{S_{11} S_{22}},
$$
the _admittance_ spectrum  (or _gain_) $G$ can be calculated from
$$
G = \gamma \sqrt{S_{22} S^{-1}_{11}},
$$
and the phase spectrum $\Phi$ can be calculated from
$$
\Phi = \arg{S_{12}}
$$

```{r, echo=TRUE}
f <- as.vector(attr(toh.cs, 'frequency'))
lf <- log10(f)
p <- 1/f
lp <- log10(p)
S <- as.matrix(toh.cs)
colnames(S) <- attr(toh.cs, 'labels')
S11 <- S[,'S11']
S12 <- S[,'S12']
S22 <- S[,'S22']
Coh <- abs(Mod(S12)^2 / (S11 * S22))
gam <- seq(0,1,by=0.001)
Pgam <- pf(2*k*gam/(1-gam), 2, 4*k)
coh.99 <- max(gam[Pgam <= 0.99])
G <- sqrt(Coh * S22 / S11)
G.err <- sqrt((1 - Coh) / k)
Phi <- atan2(x = Re(S12), y = Im(S12))
Phi2 <- Arg(S12)
all.equal(Phi, Phi2)
```

We can safely assume that the spectral density estimates for
periods longer than $\approx 200$ seconds will be either
spurious, or lacking in seismic energy, so we will exclude them.
```{r, echo=TRUE}
csd <- data.frame(f, p, lf, lp, Coh, G = G/1e9, G.err, Phi = Phi * 180 / pi)
csd.f <- subset(csd, p <= 200)
is.sig <- csd.f$Coh > coh.99
```

```{r, echo=TRUE, fig.show='hold', fig.width=7., fig.height=5.5}
layout(matrix(1:3), heights=c(1.3,2,2))
par(mar=c(0.5, 3, 0.1, 0.1), oma=c(4,0.1,2,0.1), cex=0.8, las=1)
# Coherence
plot(Coh ~ lf, csd.f, type='l', xaxt='n')
abline(h=coh.99, lty=2, col='blue')
# Admittance
plot(G ~ lf, csd.f, type='l', xaxt='n', col='lightgrey')
Gna <- csd.f$G
Gna[!is.sig] <- NA
points(csd.f$lf, Gna, pch=15, cex=0.2)
dg <- round(coef(lm(output ~ input-1, as.data.frame(toh.dat)))/1e9, 3)
abline(h=abs(dg), col='red')
# Phase
plot(Phi ~ lf, csd.f, type='l', col='lightgrey')
Phina <- csd.f$Phi
Phina[!is.sig] <- NA
points(csd.f$lf, Phina, pch=15, cex=0.2)
```
